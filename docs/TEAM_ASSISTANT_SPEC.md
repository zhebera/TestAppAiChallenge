# Team Assistant - Спецификация требований

> Документ создан по результатам интервью. Содержит решения по архитектуре, UX, компромиссам и приоритетам.

---

## 1. Общие решения

### 1.1 Режим использования
- **Решение**: Командный режим с общим сервером
- **Следствия**:
  - Необходима нормальная БД вместо JSON файлов
  - Нужна синхронизация и блокировки
  - Задачи видны всей команде

### 1.2 Интерфейс
- **Решение**: CLI достаточно
- **Язык**: Только русский
- **Частота использования**: По запросу (не постоянно в фоне)

---

## 2. Хранение данных

### 2.1 База данных
- **Решение**: SQLite + Exposed ORM
- **Обоснование**: Консистентно с остальным проектом (chat memory уже использует Exposed)
- **Миграция**: Заменить JSON файлы (data/tasks/*.json) на SQLite таблицы

### 2.2 Схема таблиц
```
tasks
├── id (PK)
├── title
├── description
├── status (enum)
├── priority (enum)
├── type (enum)
├── assignee_id (FK -> team_members)
├── reporter_id (FK -> team_members)
├── sprint_id (FK -> sprints)
├── story_points
├── due_date
├── created_at
├── updated_at
└── labels (JSON array)

task_comments
├── id (PK)
├── task_id (FK)
├── author_id
├── content
└── timestamp

task_blockers
├── task_id (FK)
└── blocked_by_task_id (FK)

team_members
├── id (PK)
├── name
├── email
├── role
└── skills (JSON array)

sprints
├── id (PK)
├── name
├── start_date
├── end_date
├── goal
└── status (enum)
```

### 2.3 История диалогов
- **Решение**: Только внутри сессии, не персистить между сессиями
- **Обоснование**: Простота и приватность

---

## 3. Интеллектуальные возможности

### 3.1 Рекомендации по приоритетам
- **Решение**: Rule-based + LLM fallback
- **Реализация**:
  1. Быстрые детерминированные правила по умолчанию:
     - CRITICAL > HIGH > MEDIUM > LOW
     - Заблокированные задачи требуют внимания
     - Задачи в спринте важнее backlog
  2. LLM вызывается для сложных случаев:
     - Конфликтующие приоритеты
     - Необходимость контекста проекта
     - Учёт навыков команды

### 3.2 Определение интента
- **Решение**: LLM intent classification (Haiku)
- **Реализация**:
  - Пре-запрос к Haiku для классификации намерения
  - Классы интентов:
    - `task_query` - запрос информации о задачах
    - `task_create` - создание задачи
    - `task_update` - изменение задачи
    - `project_status` - статус проекта
    - `recommendations` - рекомендации
    - `code_question` - вопрос о коде (RAG)
    - `general` - общий вопрос
  - На основе интента подгружается релевантный контекст

### 3.3 Создание задач натуральным языком
- **Решение**: Да, поддержать NL создание
- **Пример**: "Создай баг с critical приоритетом про утечку памяти"
- **Реализация**: LLM извлекает параметры (title, description, priority, type) из текста

### 3.4 Автоматическое назначение
- **Решение**: Только по запросу пользователя
- **Реализация**: При явном запросе "кому назначить?" матчить skills с labels

---

## 4. Модели LLM

### 4.1 Распределение моделей
| Задача | Модель | Обоснование |
|--------|--------|-------------|
| Intent classification | Haiku | Быстро и дёшево |
| Основные ответы | Sonnet | Качество важно |
| Извлечение параметров задачи | Haiku | Структурированная задача |
| Сложные рекомендации | Sonnet | Нужен контекст |

### 4.2 Контекст
- **Решение**: Максимум контекста (качество важнее стоимости)
- **Подгружать**:
  - RAG контекст (код проекта)
  - Tasks контекст (статус, задачи)
  - GitHub контекст (если релевантно)

---

## 5. RAG система

### 5.1 Обновление индекса
- **Решение**: При запуске ассистента
- **Реализация**:
  - Проверять timestamp файлов
  - Переиндексировать изменённые
  - Показывать прогресс при старте

### 5.2 Существующие настройки
- TOP_K = 5
- INITIAL_TOP_K = 10
- MIN_SIMILARITY = 0.35

---

## 6. Безопасность и UX

### 6.1 Подтверждение действий
- **Решение**: Только для деструктивных действий
- **Деструктивные действия**:
  - Удаление задачи
  - Смена исполнителя чужой задачи
  - Изменение приоритета на critical
  - Закрытие спринта

### 6.2 Защита от некорректных рекомендаций LLM
- **Решение**: Guardrails в system prompt
- **Правила в промпте**:
  - Никогда не предлагать отложить CRITICAL задачи
  - Не снижать приоритет багам без явного запроса
  - Всегда упоминать заблокированные зависимости
  - Предупреждать о рисках при смене исполнителя

---

## 7. Проактивные функции

### 7.1 Уведомления
- **Решение**: Только при запуске
- **Показывать при старте**:
  - Количество CRITICAL/HIGH задач
  - Прогресс спринта
  - Дедлайны в ближайшие 2 дня
  - Незакрытые задачи на ревью

---

## 8. Интеграции

### 8.1 GitHub Issues синхронизация
- **Приоритет**: Средний
- **Функционал**:
  - Импорт Issues как задач
  - Экспорт задач в Issues
  - Синхронизация статусов

### 8.2 Git hooks
- **Приоритет**: Средний
- **Функционал**:
  - Автоматическое обновление статуса задачи при коммите с ID
  - Обновление при мерже PR
  - Формат: `git commit -m "Fix memory leak [task_003]"`

---

## 9. Приоритет реализации

### Фаза 1: Фундамент
1. **SQLite миграция** - заменить JSON на БД
2. **Схема таблиц** - создать Exposed entities
3. **Базовые CRUD** - адаптировать TaskDataManager

### Фаза 2: Интеллект
4. **Intent classification** - Haiku пре-классификация
5. **NL создание задач** - извлечение параметров из текста
6. **Улучшенные рекомендации** - LLM fallback

### Фаза 3: UX
7. **Подтверждение деструктивных действий**
8. **Проактивные уведомления при запуске**
9. **Guardrails в промптах**

### Фаза 4: Интеграции
10. **GitHub Issues синхронизация**
11. **Git hooks**

---

## 10. Компромиссы (Tradeoffs)

| Решение | Плюсы | Минусы |
|---------|-------|--------|
| SQLite вместо Postgres | Простота, нет внешних зависимостей | Ограниченная масштабируемость |
| Haiku для intent | Быстро, дёшево | Менее точно чем Sonnet |
| Максимум контекста | Качество ответов | Больше токенов = дороже |
| RAG при запуске | Актуальный индекс | Медленный старт |
| Память только в сессии | Простота, приватность | Нет истории между сессиями |

---

## 11. Метрики успеха

- Время ответа на запрос < 3 сек (без LLM fallback)
- Точность intent classification > 90%
- Корректное извлечение параметров задачи > 85%
- Нет потери данных при конкурентном доступе

---

## 12. Открытые вопросы

1. Нужен ли веб-интерфейс в будущем?
2. Интеграция с другими трекерами (Jira, Linear)?
3. Экспорт отчётов (burndown, velocity)?

---

*Документ готов к реализации. Начинать с Фазы 1.*
