# Решение типичных проблем - LLM Chat Application

## Ошибка авторизации (401 Unauthorized)

### Симптомы:
- Ошибка "API request failed with status 401"
- Сообщение "authentication_error" или "invalid x-api-key"

### Причины:
- Неверный или истекший ANTHROPIC_API_KEY
- API ключ не установлен в переменной окружения
- Ключ содержит лишние пробелы или символы

### Решение:
1. Проверьте, что ключ установлен корректно:
   echo $ANTHROPIC_API_KEY

2. Убедитесь, что ключ актуален на console.anthropic.com
   - Войдите в личный кабинет
   - Перейдите в раздел API Keys
   - Проверьте статус ключа или создайте новый

3. Проверьте формат ключа:
   - Ключ должен начинаться с "sk-ant-"
   - Не должно быть лишних пробелов в начале или конце

4. Перезапустите терминал после установки ключа:
   - Закройте и откройте терминал заново
   - Или выполните: source ~/.bashrc (или ~/.zshrc)

5. Попробуйте установить ключ напрямую перед запуском:
   ANTHROPIC_API_KEY=sk-ant-xxx ./gradlew run


## RAG не находит документы

### Симптомы:
- Команда /rag search возвращает "Ничего не найдено"
- RAG контекст пустой в запросах

### Причины:
- Ollama сервер не запущен
- Модель эмбеддингов не установлена
- Документы не проиндексированы
- Файлы отсутствуют в папке rag_files/

### Решение:
1. Запустите Ollama сервер в отдельном терминале:
   ollama serve

2. Установите модель для эмбеддингов:
   ollama pull mxbai-embed-large

3. Проиндексируйте файлы:
   - В приложении выполните: /rag index
   - Или для переиндексации: /rag reindex

4. Проверьте наличие файлов:
   ls rag_files/

5. Проверьте статус индекса:
   /rag status


## MCP серверы не подключаются

### Симптомы:
- Ошибка "Failed to start MCP server"
- Ошибка "Connection refused"
- Инструменты MCP недоступны

### Причины:
- Java не установлена или не в PATH
- Версия Java ниже 17
- Classpath не настроен
- Порт занят другим процессом

### Решение:
1. Проверьте версию Java:
   java -version
   # Должна быть 17 или выше

2. Установите Java если отсутствует:
   # macOS: brew install openjdk@21
   # Ubuntu: sudo apt install openjdk-21-jdk

3. Проверьте JAVA_HOME:
   echo $JAVA_HOME

4. Перезапустите приложение:
   ./gradlew run

5. Проверьте логи на наличие ошибок

6. Для отладки запустите MCP сервер вручную:
   ./gradlew runFileStorageMcp
   ./gradlew runCrmMcp


## Медленные ответы от модели

### Симптомы:
- Ответы приходят через минуту и больше
- Частые таймауты
- Зависание при генерации

### Причины:
- Большой контекст (длинная история диалога)
- Много результатов RAG в контексте
- Сетевые задержки или проблемы с API
- Высокая нагрузка на серверах Anthropic

### Решение:
1. Очистите историю диалога:
   /new
   или
   /clear

2. Уменьшите количество RAG результатов:
   /rag threshold 0.6  # увеличить порог релевантности

3. Отключите RAG временно:
   /rag off

4. Проверьте интернет-соединение:
   ping api.anthropic.com

5. Уменьшите максимальное количество токенов:
   /maxTokens 512


## Ошибка "Rate limit exceeded"

### Симптомы:
- Ошибка 429 Too Many Requests
- Сообщение о превышении лимита запросов

### Причины:
- Превышен лимит запросов к API
- Слишком частые запросы
- Лимит токенов исчерпан

### Решение:
1. Подождите несколько минут перед следующим запросом

2. Проверьте лимиты на console.anthropic.com

3. Используйте более легкую модель:
   - Haiku вместо Sonnet для простых задач

4. Уменьшите частоту запросов


## Ошибки при сборке проекта

### Симптомы:
- ./gradlew build завершается с ошибкой
- Ошибки компиляции

### Решение:
1. Очистите кэш Gradle:
   ./gradlew clean

2. Обновите зависимости:
   ./gradlew build --refresh-dependencies

3. Проверьте версию Kotlin и Gradle:
   - Kotlin 2.2+
   - Gradle 8.x+

4. Проверьте JDK:
   java -version  # должна быть 17+


## GitHub MCP сервер не работает

### Симптомы:
- Ошибки при работе с git_push или create_pull_request
- "GITHUB_TOKEN not set"

### Причины:
- Не установлен GitHub токен
- GitHub CLI не установлен
- Недостаточно прав у токена

### Решение:
1. Установите GitHub токен:
   export GITHUB_TOKEN=your_token_here

2. Установите GitHub CLI:
   brew install gh  # macOS

3. Авторизуйтесь в GitHub CLI:
   gh auth login

4. Проверьте права токена:
   - Должны быть права: repo, workflow


## Ошибки SQLite / базы данных

### Симптомы:
- Ошибки при сохранении истории
- "Database locked"
- Ошибки доступа к файлу БД

### Решение:
1. Закройте другие экземпляры приложения

2. Удалите файл базы данных и перезапустите:
   rm chat_memory.db
   ./gradlew run

3. Проверьте права доступа к директории


## Кодировка символов / UTF-8 проблемы

### Симптомы:
- Кракозябры вместо кириллицы
- Ошибки кодировки в консоли

### Решение:
1. Убедитесь, что терминал использует UTF-8

2. Запустите с явным указанием кодировки:
   JAVA_OPTS="-Dfile.encoding=UTF-8" ./gradlew run

3. Проверьте настройки терминала:
   echo $LANG  # должно содержать UTF-8
